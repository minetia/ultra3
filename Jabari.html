<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ï£ºÍµ∞Ïùò AI AUTO (Java Connected)</title>
    <style>
        /* [Ïä§ÌÉÄÏùº] Ïú†ÎãàÎ≤ÑÏÑ§ Î∑∞Ìè¨Ìä∏ & Îã§ÌÅ¨ ÌÖåÎßà */
        html { background-color: #000; height: 100%; }
        body { 
            background: #0b0e11; color: #eaecef; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0 auto; padding: 16px; padding-bottom: 120px; 
            max-width: 500px; min-height: 100vh; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); box-sizing: border-box;
        }
        :root { --bg: #0b0e11; --card: #1e2329; --up: #0ecb81; --down: #f6465d; --gold: #f0b90b; --slot-bg: #2b3139; --danger: #ff0000; }

        /* Ìó§Îçî */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #2b3139; }
        .app-title { font-size: 18px; font-weight: 900; color: #fff; letter-spacing: 1px; }
        .top-ai-badge { 
            font-size: 11px; font-weight: 800; padding: 6px 12px; border-radius: 20px;
            background: #1a1a1a; color: #555; border: 1px solid #333; 
            display: flex; align-items: center; gap: 6px; transition: all 0.3s; 
        }
        .top-ai-badge.on { background: rgba(14, 203, 129, 0.15); color: var(--up); border-color: var(--up); box-shadow: 0 0 10px rgba(14, 203, 129, 0.3); }
        .indicator-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .top-ai-badge.on .indicator-dot { background: var(--up); animation: blinkDot 1s infinite; }
        @keyframes blinkDot { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* ÏöîÏïΩ Ïπ¥Îìú */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--card); padding: 15px 10px; border-radius: 16px; text-align: center; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .stat-card small { color: #848e9c; font-size: 10px; display: block; margin-bottom: 5px; font-weight: 600; opacity: 0.8; }
        .stat-card .val { font-size: 15px; font-weight: 800; color: #fff; font-family: 'Roboto', sans-serif; }

        /* ÌÑ∞ÎØ∏ÎÑê */
        .terminal-box { 
            background: #161a1e; border: 1px solid #2b3139; border-radius: 20px;
            padding: 16px; margin-bottom: 20px; min-height: 200px; height: auto; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }
        .terminal-header { border-bottom: 1px solid #2b3139; padding-bottom: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 13px; font-weight: bold; color: #848e9c; letter-spacing: 0.5px; }
        .ai-status-text { font-size: 11px; color: var(--gold); font-weight: bold; }

        /* Ïä¨Î°Ø ÏïÑÏù¥ÌÖú */
        .slot-container { display: flex; flex-direction: column; gap: 10px; }
        .slot-item { 
            background: var(--slot-bg); border-radius: 16px;
            padding: 14px; border-left: 4px solid #444; 
            display: flex; justify-content: space-between; align-items: center; 
            transition: transform 0.1s, background-color 0.2s; cursor: pointer; user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .slot-item:active { transform: scale(0.98); background: #333; }
        .flash-up { background-color: rgba(14, 203, 129, 0.15) !important; }
        .flash-down { background-color: rgba(246, 70, 93, 0.15) !important; }

        .coin-info { display: flex; flex-direction: column; gap: 4px; }
        .coin-header { display: flex; align-items: center; gap: 8px; }
        .coin-sym { font-size: 15px; font-weight: 800; color: #fff; }
        .lev-badge { font-size: 9px; background: #444; color: #ccc; padding: 2px 6px; border-radius: 6px; font-weight: bold; }
        .side-badge { font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 6px; }
        .side-long { color: var(--up); background: rgba(14, 203, 129, 0.15); }
        .side-short { color: var(--down); background: rgba(246, 70, 93, 0.15); }
        .auto-tag { display: inline-block; font-size: 9px; font-weight: bold; color: #000; background: var(--gold); padding: 1px 5px; border-radius: 6px; margin-left: 5px; }
        .size-badge { font-size: 9px; color: #888; font-family: monospace; border: 1px solid #444; padding: 1px 4px; border-radius: 4px; margin-left: 4px; }

        .detail-row { font-size: 11px; color: #848e9c; display: flex; gap: 10px; font-family: 'Roboto', sans-serif; align-items: center; }
        .liq-val { color: #f0b90b; font-weight: bold; }
        .liq-dist { font-size: 10px; font-weight: bold; color: #666; }
        .danger-dist { color: var(--danger) !important; animation: blinkRed 1s infinite; font-weight: 900; }
        @keyframes blinkRed { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .money-row { margin-top: 4px; padding-top: 6px; border-top: 1px dashed #3a3a3a; display: flex; justify-content: space-between; font-size: 11px; }
        .money-label { color: #666; }
        .money-val { font-weight: bold; font-family: monospace; color: #eee; }

        .slot-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .pnl-text { font-size: 15px; font-weight: 800; margin-left: 5px; }
        .pnl-val { font-size: 12px; font-weight: 600; margin-top: 2px; }
        .close-btn { background: #3a3a3a; border: none; color: #aaa; padding: 5px 10px; font-size: 10px; border-radius: 8px; cursor: pointer; margin-top: 6px; font-weight: 600; }

        /* Ïª®Ìä∏Î°§ Ìå®ÎÑê */
        .control-panel { 
            background: var(--card); padding: 16px; border-radius: 20px; 
            border: 1px solid #2b3139; display: flex; flex-direction: column; gap: 10px; transition: border-color 0.3s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .input-row { display: grid; grid-template-columns: 1.4fr 1fr 0.8fr; gap: 8px; }
        select, input { 
            width: 100%; padding: 12px; background: #0b0e11; border: 1px solid #333; 
            border-radius: 10px; color: #fff; font-weight: bold; font-size: 13px; 
            outline: none; box-sizing: border-box; transition: border-color 0.2s;
        }
        select:focus, input:focus { border-color: #555; }
        select:disabled { color: #555; background: #151515; border-color: #222; }
        optgroup { color: #848e9c; font-weight: bold; font-size: 11px; }

        .dca-panel { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; background: #151515; padding: 12px; border-radius: 12px; border: 1px dashed #444; }
        .dca-label { font-size: 10px; color: #848e9c; display: block; margin-bottom: 4px; font-weight: 600; }

        .ai-mode-panel { display: flex; gap: 8px; margin-top: 4px; }
        .mode-select { flex: 1; background: #151515; color: var(--gold); border: 1px solid var(--gold); font-weight: bold; border-radius: 10px; }

        .btn-row { display: flex; gap: 8px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 800; font-size: 13px; cursor: pointer; transition: transform 0.1s; }
        .btn:active { transform: scale(0.97); }
        .btn-long { background: var(--up); color: #fff; box-shadow: 0 4px 10px rgba(14, 203, 129, 0.2); }
        .btn-short { background: var(--down); color: #fff; box-shadow: 0 4px 10px rgba(246, 70, 93, 0.2); }
        .btn-auto { background: #2b3139; color: #848e9c; border: 1px solid #444; transition: all 0.3s; }
        
        .btn-auto.stable { background: rgba(14, 203, 129, 0.15); color: var(--up); border: 1px solid var(--up); }
        .btn-auto.moderate { background: rgba(240, 185, 11, 0.15); color: var(--gold); border: 1px solid var(--gold); }
        .btn-auto.aggressive { background: rgba(246, 70, 93, 0.15); color: var(--down); border: 1px solid var(--down); }
        .btn-dca-on { background: rgba(14, 203, 129, 0.2) !important; color: var(--up) !important; border: 1px solid var(--up) !important; font-weight: 900; }

        .wake-lock-btn { 
            background: #151515; border: 1px solid #444; color: #777; 
            padding: 12px; width: 100%; border-radius: 12px; font-size: 12px; font-weight: bold; 
            margin-top: 10px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .wake-lock-btn.active { background: #222; color: var(--up); border-color: var(--up); box-shadow: 0 0 10px rgba(14, 203, 129, 0.1); }

        .log-box { padding: 12px; background: #0b0e11; border-radius: 12px; height: 80px; overflow-y: scroll; font-size: 11px; color: #848e9c; border: 1px solid #2b3139; font-family: monospace; margin-top: 15px; }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="app-title">AI COMMANDER</div>
        <div id="top-ai-badge" class="top-ai-badge">
            <div class="indicator-dot"></div>
            <span id="top-ai-text">SYSTEM OFF</span>
        </div>
    </div>

    <div class="summary-grid">
        <div class="stat-card"><small>Ï¥ù ÏûêÏÇ∞ (Equity)</small><div id="total-val" class="val">10,000.00</div></div>
        <div class="stat-card"><small>Ïö¥Ïö© Ïä¨Î°Ø</small><div class="val"><span id="active-count" style="color:var(--gold)">0</span> / 20</div></div>
        <div class="stat-card"><small>ÎØ∏Ïã§ÌòÑ ÏÜêÏùµ</small><div id="pnl-val" class="val">0.00</div></div>
    </div>

    <div class="terminal-box">
        <div class="terminal-header">
            <span class="header-title">TACTICAL MAP (ONLINE)</span>
            <span id="ai-activity-text" class="ai-status-text"></span>
        </div>
        <div id="slot-container" class="slot-container">
            <div id="empty-msg" style="text-align:center;color:#444;padding:40px 0;font-size:12px;">NO POSITIONS</div>
        </div>
        <div style="height: 20px;"></div>
    </div>

    <div class="control-panel" id="control-panel">
        <div class="input-row">
            <select id="coin-select">
                <optgroup label="‚òÖ CORE">
                    <option value="BTC">BTC</option><option value="ETH">ETH</option><option value="SOL">SOL</option><option value="BNB">BNB</option><option value="XRP">XRP</option><option value="ZRX">ZRX</option><option value="ONDO">ONDO</option><option value="SUI">SUI</option>
                </optgroup>
                <optgroup label="LAYER 1 & 2">
                    <option value="ADA">ADA</option><option value="AVAX">AVAX</option><option value="DOT">DOT</option><option value="TRX">TRX</option><option value="MATIC">MATIC</option><option value="LINK">LINK</option><option value="ATOM">ATOM</option><option value="NEAR">NEAR</option><option value="APT">APT</option><option value="ARB">ARB</option><option value="OP">OP</option><option value="STX">STX</option>
                </optgroup>
                <optgroup label="AI & RWA">
                    <option value="RNDR">RNDR</option><option value="FET">FET</option><option value="WLD">WLD</option><option value="TAO">TAO</option><option value="INJ">INJ</option><option value="JASMY">JASMY</option><option value="GALA">GALA</option><option value="SAND">SAND</option>
                </optgroup>
                <optgroup label="DEFI & LEGACY">
                    <option value="UNI">UNI</option><option value="AAVE">AAVE</option><option value="MKR">MKR</option><option value="SNX">SNX</option><option value="LTC">LTC</option><option value="BCH">BCH</option><option value="ETC">ETC</option><option value="EOS">EOS</option><option value="XLM">XLM</option><option value="ALGO">ALGO</option>
                </optgroup>
                <optgroup label="MEME SQUAD">
                    <option value="DOGE">DOGE</option><option value="SHIB">SHIB</option><option value="PEPE">PEPE</option><option value="WIF">WIF</option><option value="FLOKI">FLOKI</option><option value="BONK">BONK</option><option value="BOME">BOME</option><option value="MEME">MEME</option>
                </optgroup>
            </select>
            <select id="market-select" onchange="handleMarketChange()">
                <option value="SPOT">ÌòÑÎ¨º</option>
                <option value="FUT">ÏÑ†Î¨º</option>
            </select>
            <select id="lev-select" disabled>
                <option value="1">1x</option><option value="5">5x</option><option value="10" selected>10x</option>
                <option value="20">20x</option><option value="50">50x</option><option value="125">Max</option>
            </select>
        </div>
        <input type="number" id="margin-input" placeholder="ÏßÑÏûÖ Í∏àÏï° ($)" value="1000">
        
        <div class="dca-panel">
            <div><span class="dca-label">Ï∂îÎß§ GAP (%)</span><input type="number" id="dca-gap" value="-2.0" step="0.1"></div>
            <div><span class="dca-label">Ï∂îÎß§ Î∞∞Ïàò (x)</span><input type="number" id="dca-mult" value="1.0" step="0.1"></div>
            <div>
                <span class="dca-label">ÏûêÎèô Ï∂îÎß§</span>
                <button id="dca-btn" class="btn-auto" style="width:100%; padding:8px; font-size:10px;" onclick="toggleDCA()">OFF</button>
            </div>
        </div>

        <div class="ai-mode-panel">
            <select id="ai-mode-select" class="mode-select" onchange="updateAIModeColor()">
                <option value="STABLE">üõ°Ô∏è ÏïàÏ†ïÌòï (ÌòÑÎ¨ºÏúÑÏ£º)</option>
                <option value="MODERATE" selected>‚öñÔ∏è Î∞∏Îü∞Ïä§ (Ï§ëÍ∞Ñ)</option>
                <option value="AGGRESSIVE">‚öîÔ∏è Í≥µÍ≤©Ìòï (Í≥†Î†àÎ≤Ñ)</option>
            </select>
        </div>

        <div class="btn-row" style="margin-top:6px;">
            <button class="btn btn-long" onclick="manualEntry('LONG')">Îß§Ïàò / Î°±</button>
            <button id="short-btn" class="btn btn-short" onclick="manualEntry('SHORT')" disabled>Îß§ÎèÑ / Ïàè</button>
        </div>
        <div class="btn-row">
             <button id="auto-btn" class="btn btn-auto" onclick="toggleAuto()">ü§ñ AI START</button>
        </div>
        
        <button id="wake-lock-btn" class="wake-lock-btn" onclick="toggleWakeLock()">
            <span>‚ö° ÌôîÎ©¥ Í∫ºÏßê Î∞©ÏßÄ (No Sleep)</span>
        </button>
    </div>

    <div class="log-box" id="sys-log">> SYSTEM READY. WAITING FOR JAVA ENGINE...</div>

<script>
    let cash = 10000; 
    let portfolio = {}; 
    let prices = {}; 
    let isAuto = false;
    let isDCA = false;
    let wakeLock = null;
    let serverConnected = false;

    // [Ï§ëÏöî] ÏûêÎ∞î ÏóîÏßÑ(Ïä§ÌîÑÎßÅ Î∂ÄÌä∏) Ï£ºÏÜå
    const SERVER_URL = "http://localhost:8080/api";

    // ------------------------------------------------------------
    // [ÌïµÏã¨] ÏûêÎ∞î ÏÑúÎ≤ÑÏôÄ ÌÜµÏã† (Bridge)
    // ------------------------------------------------------------
    async function communicateWithJava() {
        try {
            // 1. ÏûêÎ∞î ÏÑúÎ≤ÑÏóê Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ (Scan)
            const res = await fetch(`${SERVER_URL}/scan`);
            const data = await res.json();
            
            // 2. Ïó∞Í≤∞ ÏÑ±Í≥µ Ïãú UI ÏóÖÎç∞Ïù¥Ìä∏
            if(!serverConnected) {
                serverConnected = true;
                addLog("ÏãúÏä§ÌÖú", "Ìä∏Î†àÏù¥Îî© ÎßàÏà†ÏÇ¨(Java) Ïó∞Í≤∞ ÏÑ±Í≥µ!", "var(--up)");
                const title = document.querySelector('.header-title');
                title.innerText = "TACTICAL MAP (ONLINE)";
                title.style.color = "var(--up)";
                document.getElementById('top-ai-badge').style.borderColor = "var(--up)";
            }

            // 3. Í∞ÄÍ≤© Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
            const sym = data.symbol;
            prices[sym] = data.price;
            
            // 4. AI Ïã†Ìò∏ Í∞êÏßÄ Î∞è Ïã§Ìñâ
            const activity = document.getElementById('ai-activity-text');
            if (isAuto) {
                activity.innerText = `ÏûêÎ∞î AI Î∂ÑÏÑùÏ§ë: ${sym} (RSI: ${data.rsi})`;
                
                if (data.signal === "BUY") {
                    // Ïù¥ÎØ∏ Î≥¥Ïú†Ï§ëÏù¥ ÏïÑÎãàÍ≥†, Ïä¨Î°Ø Ïó¨Ïú†Í∞Ä ÏûàÏúºÎ©¥ ÏßÑÏûÖ
                    if (!portfolio[sym] && Object.keys(portfolio).length < 20) {
                        // AI Î™®ÎìúÏóê Îî∞Î•∏ ÏßÑÏûÖ Ï†ÑÎûµ
                        const mode = document.getElementById('ai-mode-select').value;
                        let lev = 1; let market = "SPOT";
                        
                        if(mode === "AGGRESSIVE") { lev = 20; market = "FUT"; }
                        else if(mode === "MODERATE") { lev = 5; market = "FUT"; }
                        
                        executeEntry(sym, 1000, market, "LONG", lev, true, `(AI RSI: ${data.rsi})`);
                    }
                }
            } else {
                activity.innerText = "ÎåÄÍ∏∞Ï§ë...";
            }

            checkLiquidation();
            updateDashboard();

        } catch (e) {
            // Ïó∞Í≤∞ Ïã§Ìå® Ïãú
            if(serverConnected) {
                serverConnected = false;
                addLog("Í≤ΩÍ≥†", "ÏóîÏßÑ Ïó∞Í≤∞ ÎÅäÍπÄ.. Ïû¨Ï†ëÏÜç ÏãúÎèÑ", "var(--danger)");
                const title = document.querySelector('.header-title');
                title.innerText = "TACTICAL MAP (OFFLINE)";
                title.style.color = "var(--danger)";
            }
            // ÎπÑÏÉÅÏö© ÏãúÎÆ¨Î†àÏù¥ÏÖò Îç∞Ïù¥ÌÑ∞ Í∞ÄÎèô (ÌôîÎ©¥ Î©àÏ∂§ Î∞©ÏßÄ)
            runSimulationFallback();
        }
    }

    function runSimulationFallback() {
        // ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏïàÎê† Îïå UI ÌÖåÏä§Ìä∏Ïö© Í∞ÄÏßú Îç∞Ïù¥ÌÑ∞
        const coins = ["BTC","ETH","SOL","XRP"];
        const sym = coins[Math.floor(Math.random()*coins.length)];
        if(!prices[sym]) prices[sym] = 1000;
        prices[sym] = prices[sym] * (1 + (Math.random() - 0.5) * 0.01);
        updateDashboard();
    }

    // [Ï£ºÎ¨∏ Ï†ÑÏÜ°] ÏàòÎèô Îß§Ïàò Ïãú ÏûêÎ∞î ÏÑúÎ≤ÑÎ°ú Î™ÖÎ†π ÌïòÎã¨
    async function sendOrderToServer(symbol, amount, side) {
        if (!serverConnected) return;
        try {
            await fetch(`${SERVER_URL}/order`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ symbol, amount, side })
            });
            // addLog("ÏãúÏä§ÌÖú", "ÏÑúÎ≤ÑÎ°ú Ï£ºÎ¨∏ Ï†ÑÏÜ° ÏôÑÎ£å", "#aaa");
        } catch (e) { console.error("Ï£ºÎ¨∏ Ï†ÑÏÜ° Ïã§Ìå®"); }
    }

    // ------------------------------------------------------------
    // [Í∏∞Ï°¥ Ï†ÑÏà† Î°úÏßÅ] (UI Ï†úÏñ¥ Î∞è Í≥ÑÏÇ∞)
    // ------------------------------------------------------------
    
    function executeEntry(symbol, marginUSD, market, side, lev, isAutoTrade, reason="") {
        if (!prices[symbol] && !serverConnected) return;
        const price = prices[symbol] || 100;

        // ÏàòÎèô Ï£ºÎ¨∏Ïù¥Î©¥ ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°
        if (!isAutoTrade) sendOrderToServer(symbol, marginUSD, side);

        if (portfolio[symbol]) {
            // Ï†ïÎ∞Ä Ï∂îÎß§ Í≥ÑÏÇ∞
            const oldSize = portfolio[symbol].margin * portfolio[symbol].lev;
            const newSize = marginUSD * lev;
            const oldQty = oldSize / portfolio[symbol].avg;
            const newQty = newSize / price;
            
            portfolio[symbol].avg = (oldSize + newSize) / (oldQty + newQty);
            portfolio[symbol].margin += marginUSD;
            addLog(isAutoTrade ? "[AI] Ï∂îÎß§" : "[ÏàòÎèô] Ï∂îÎß§", `${symbol} ${reason} (+$${Math.floor(marginUSD)})`, "var(--gold)");
        } 
        else {
            if (Object.keys(portfolio).length >= 20) return;
            portfolio[symbol] = { avg: price, margin: marginUSD, market: market, side: side, lev: lev, isAuto: isAutoTrade };
            
            let badge = isAutoTrade ? "[AI]" : "[ÏàòÎèô]";
            if(isAutoTrade) {
                const mode = document.getElementById('ai-mode-select').value;
                if(mode === 'STABLE') badge = "[ÏïàÏ†ïAI]";
                if(mode === 'AGGRESSIVE') badge = "[Í≥µÍ≤©AI]";
            }
            addLog(badge, `${symbol} ${side} x${lev} ÏßÑÏûÖ`, side==="LONG"?"var(--up)":"var(--down)");
        }
        cash -= marginUSD;
        updateDashboard();
    }

    function updateDashboard() {
        const container = document.getElementById('slot-container');
        if (Object.keys(portfolio).length === 0) {
            if(!document.getElementById('empty-msg')) container.innerHTML = '<div id="empty-msg" style="text-align:center;color:#444;padding:40px 0;font-size:12px;">NO POSITIONS</div>';
        } else {
            if(document.getElementById('empty-msg')) document.getElementById('empty-msg').remove();
        }

        let totalPnL = 0; let usedMargin = 0; let count = 0;
        for (let sym in portfolio) {
            count++;
            const d = portfolio[sym];
            const p = prices[sym] || d.avg;
            const liq = getLiqPrice(d);
            
            // PnL Ï†ïÎ∞Ä Í≥ÑÏÇ∞
            const positionSize = d.margin * d.lev;
            const coinSize = positionSize / d.avg;
            let pnl = d.side === "LONG" ? (p - d.avg) * coinSize : (d.avg - p) * coinSize;
            const roe = (pnl / d.margin) * 100;
            totalPnL += pnl; usedMargin += d.margin;
            const currentEquity = d.margin + pnl;

            // Ï≤≠ÏÇ∞ Gap Î∞è ÏúÑÌóòÎèÑ
            let distText = ""; let dangerClass = ""; let riskIcon = "";
            if (d.lev >= 20) riskIcon = "üî•"; if (d.lev >= 50) riskIcon = "üíÄ";

            if (d.lev > 1) {
                const gapPrice = Math.abs(p - liq);
                const gapPercent = ((liq - p) / p) * 100;
                distText = `Gap: $${gapPrice.toFixed(2)} (${gapPercent > 0 ? '+' : ''}${gapPercent.toFixed(1)}%)`;
                if (Math.abs(gapPercent) < 3.0) dangerClass = "danger-dist";
            }

            let slot = document.getElementById(`slot-${sym}`);
            if (!slot) {
                slot = document.createElement('div');
                slot.id = `slot-${sym}`;
                slot.className = 'slot-item';
                slot.setAttribute('onclick', `selectActiveCoin('${sym}', '${d.market}')`);
                slot.innerHTML = `
                    <div class="coin-info">
                        <div class="coin-header">
                            <span class
