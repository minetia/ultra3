<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ï£ºÍµ∞Ïùò AI AUTO (List Fixed)</title>
    <style>
        /* [Ïä§ÌÉÄÏùº] Ïú†ÎãàÎ≤ÑÏÑ§ Î∑∞Ìè¨Ìä∏ & Îã§ÌÅ¨ ÌÖåÎßà */
        html { background-color: #000; height: 100%; }
        body { 
            background: #0b0e11; color: #eaecef; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0 auto; padding: 16px; padding-bottom: 150px; /* ÌïòÎã® Ïó¨Î∞± Ï∂©Î∂ÑÌûà ÌôïÎ≥¥ */
            max-width: 500px; min-height: 100vh; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); box-sizing: border-box;
        }
        :root { --bg: #0b0e11; --card: #1e2329; --up: #0ecb81; --down: #f6465d; --gold: #f0b90b; --slot-bg: #2b3139; --danger: #ff0000; }

        /* Ìó§Îçî */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #2b3139; }
        .app-title { font-size: 18px; font-weight: 900; color: #fff; letter-spacing: 1px; }
        .top-ai-badge { 
            font-size: 11px; font-weight: 800; padding: 6px 12px; border-radius: 20px;
            background: #1a1a1a; color: #555; border: 1px solid #333; 
            display: flex; align-items: center; gap: 6px; transition: all 0.3s; 
        }
        .top-ai-badge.on { background: rgba(14, 203, 129, 0.15); color: var(--up); border-color: var(--up); box-shadow: 0 0 10px rgba(14, 203, 129, 0.3); }
        .indicator-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .top-ai-badge.on .indicator-dot { background: var(--up); animation: blinkDot 1s infinite; }
        @keyframes blinkDot { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* ÏöîÏïΩ Ïπ¥Îìú */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--card); padding: 15px 10px; border-radius: 16px; text-align: center; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .stat-card small { color: #848e9c; font-size: 10px; display: block; margin-bottom: 5px; font-weight: 600; opacity: 0.8; }
        .stat-card .val { font-size: 15px; font-weight: 800; color: #fff; font-family: 'Roboto', sans-serif; }

        /* ÌÑ∞ÎØ∏ÎÑê */
        .terminal-box { 
            background: #161a1e; border: 1px solid #2b3139; border-radius: 20px;
            padding: 16px; margin-bottom: 20px; 
            min-height: 200px; height: auto; /* ÎÜíÏù¥ ÏûêÎèô Ï°∞Ï†à */
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }
        .terminal-header { border-bottom: 1px solid #2b3139; padding-bottom: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 13px; font-weight: bold; color: #848e9c; letter-spacing: 0.5px; }
        .ai-status-text { font-size: 11px; color: var(--gold); font-weight: bold; }

        /* Ïä¨Î°Ø ÏïÑÏù¥ÌÖú */
        .slot-container { display: flex; flex-direction: column; gap: 10px; }
        .slot-item { 
            background: var(--slot-bg); border-radius: 16px;
            padding: 14px; border-left: 4px solid #444; 
            display: flex; justify-content: space-between; align-items: center; 
            transition: transform 0.1s, background-color 0.2s; cursor: pointer; user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .slot-item:active { transform: scale(0.98); background: #333; }
        .flash-up { background-color: rgba(14, 203, 129, 0.15) !important; }
        .flash-down { background-color: rgba(246, 70, 93, 0.15) !important; }

        .coin-info { display: flex; flex-direction: column; gap: 4px; }
        .coin-header { display: flex; align-items: center; gap: 8px; }
        .coin-sym { font-size: 15px; font-weight: 800; color: #fff; }
        .lev-badge { font-size: 9px; background: #444; color: #ccc; padding: 2px 6px; border-radius: 6px; font-weight: bold; }
        .side-badge { font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 6px; }
        .side-long { color: var(--up); background: rgba(14, 203, 129, 0.15); }
        .side-short { color: var(--down); background: rgba(246, 70, 93, 0.15); }
        .auto-tag { display: inline-block; font-size: 9px; font-weight: bold; color: #000; background: var(--gold); padding: 1px 5px; border-radius: 6px; margin-left: 5px; }
        .size-badge { font-size: 9px; color: #888; font-family: monospace; border: 1px solid #444; padding: 1px 4px; border-radius: 4px; margin-left: 4px; }

        .detail-row { font-size: 11px; color: #848e9c; display: flex; gap: 10px; font-family: 'Roboto', sans-serif; align-items: center; }
        .liq-val { color: #f0b90b; font-weight: bold; }
        .liq-dist { font-size: 10px; font-weight: bold; color: #666; }
        .danger-dist { color: var(--danger) !important; animation: blinkRed 1s infinite; font-weight: 900; }
        @keyframes blinkRed { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .money-row { margin-top: 4px; padding-top: 6px; border-top: 1px dashed #3a3a3a; display: flex; justify-content: space-between; font-size: 11px; }
        .money-label { color: #666; }
        .money-val { font-weight: bold; font-family: monospace; color: #eee; }

        .slot-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .pnl-text { font-size: 15px; font-weight: 800; margin-left: 5px; }
        .pnl-val { font-size: 12px; font-weight: 600; margin-top: 2px; }
        .close-btn { background: #3a3a3a; border: none; color: #aaa; padding: 5px 10px; font-size: 10px; border-radius: 8px; cursor: pointer; margin-top: 6px; font-weight: 600; }

        /* Ïª®Ìä∏Î°§ Ìå®ÎÑê */
        .control-panel { 
            background: var(--card); padding: 16px; border-radius: 20px; 
            border: 1px solid #2b3139; display: flex; flex-direction: column; gap: 10px; transition: border-color 0.3s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .input-row { display: grid; grid-template-columns: 1.4fr 1fr 0.8fr; gap: 8px; }
        select, input { 
            width: 100%; padding: 12px; background: #0b0e11; border: 1px solid #333; 
            border-radius: 10px; color: #fff; font-weight: bold; font-size: 13px; 
            outline: none; box-sizing: border-box; transition: border-color 0.2s;
        }
        select:focus, input:focus { border-color: #555; }
        select:disabled { color: #555; background: #151515; border-color: #222; }
        optgroup { color: #848e9c; font-weight: bold; font-size: 11px; }

        .dca-panel { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; background: #151515; padding: 12px; border-radius: 12px; border: 1px dashed #444; }
        .dca-label { font-size: 10px; color: #848e9c; display: block; margin-bottom: 4px; font-weight: 600; }

        .ai-mode-panel { display: flex; gap: 8px; margin-top: 4px; }
        .mode-select { flex: 1; background: #151515; color: var(--gold); border: 1px solid var(--gold); font-weight: bold; border-radius: 10px; }

        .btn-row { display: flex; gap: 8px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 800; font-size: 13px; cursor: pointer; transition: transform 0.1s; }
        .btn:active { transform: scale(0.97); }
        .btn-long { background: var(--up); color: #fff; box-shadow: 0 4px 10px rgba(14, 203, 129, 0.2); }
        .btn-short { background: var(--down); color: #fff; box-shadow: 0 4px 10px rgba(246, 70, 93, 0.2); }
        .btn-auto { background: #2b3139; color: #848e9c; border: 1px solid #444; transition: all 0.3s; }
        
        .btn-auto.stable { background: rgba(14, 203, 129, 0.15); color: var(--up); border: 1px solid var(--up); }
        .btn-auto.moderate { background: rgba(240, 185, 11, 0.15); color: var(--gold); border: 1px solid var(--gold); }
        .btn-auto.aggressive { background: rgba(246, 70, 93, 0.15); color: var(--down); border: 1px solid var(--down); }
        .btn-dca-on { background: rgba(14, 203, 129, 0.2) !important; color: var(--up) !important; border: 1px solid var(--up) !important; font-weight: 900; }

        .wake-lock-btn { 
            background: #151515; border: 1px solid #444; color: #777; 
            padding: 12px; width: 100%; border-radius: 12px; font-size: 12px; font-weight: bold; 
            margin-top: 10px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .wake-lock-btn.active { background: #222; color: var(--up); border-color: var(--up); box-shadow: 0 0 10px rgba(14, 203, 129, 0.1); }

        .log-box { padding: 12px; background: #0b0e11; border-radius: 12px; height: 80px; overflow-y: scroll; font-size: 11px; color: #848e9c; border: 1px solid #2b3139; font-family: monospace; margin-top: 15px; }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="app-title">AI COMMANDER</div>
        <div id="top-ai-badge" class="top-ai-badge">
            <div class="indicator-dot"></div>
            <span id="top-ai-text">SYSTEM OFF</span>
        </div>
    </div>

    <div class="summary-grid">
        <div class="stat-card"><small>Ï¥ù ÏûêÏÇ∞ (Equity)</small><div id="total-val" class="val">10,000.00</div></div>
        <div class="stat-card"><small>Ïö¥Ïö© Ïä¨Î°Ø</small><div class="val"><span id="active-count" style="color:var(--gold)">0</span> / 20</div></div>
        <div class="stat-card"><small>ÎØ∏Ïã§ÌòÑ ÏÜêÏùµ</small><div id="pnl-val" class="val">0.00</div></div>
    </div>

    <div class="terminal-box">
        <div class="terminal-header">
            <span class="header-title">TACTICAL MAP (WEB CLOUD)</span>
            <span id="ai-activity-text" class="ai-status-text"></span>
        </div>
        <div id="slot-container" class="slot-container">
            </div>
    </div>

    <div class="control-panel" id="control-panel">
        <div class="input-row">
            <select id="coin-select">
                <optgroup label="‚òÖ CORE">
                    <option value="BTC">BTC</option><option value="ETH">ETH</option><option value="SOL">SOL</option><option value="BNB">BNB</option><option value="XRP">XRP</option><option value="ZRX">ZRX</option><option value="ONDO">ONDO</option><option value="SUI">SUI</option>
                </optgroup>
                <optgroup label="LAYER 1 & 2">
                    <option value="ADA">ADA</option><option value="AVAX">AVAX</option><option value="DOT">DOT</option><option value="TRX">TRX</option><option value="MATIC">MATIC</option><option value="LINK">LINK</option><option value="ATOM">ATOM</option><option value="NEAR">NEAR</option><option value="APT">APT</option><option value="ARB">ARB</option><option value="OP">OP</option><option value="STX">STX</option>
                </optgroup>
                <optgroup label="AI & RWA">
                    <option value="RNDR">RNDR</option><option value="FET">FET</option><option value="WLD">WLD</option><option value="TAO">TAO</option><option value="INJ">INJ</option><option value="JASMY">JASMY</option><option value="GALA">GALA</option><option value="SAND">SAND</option>
                </optgroup>
                <optgroup label="MEME SQUAD">
                    <option value="DOGE">DOGE</option><option value="SHIB">SHIB</option><option value="PEPE">PEPE</option><option value="WIF">WIF</option><option value="FLOKI">FLOKI</option><option value="BONK">BONK</option><option value="BOME">BOME</option><option value="MEME">MEME</option>
                </optgroup>
            </select>
            <select id="market-select" onchange="handleMarketChange()">
                <option value="SPOT">ÌòÑÎ¨º</option>
                <option value="FUT">ÏÑ†Î¨º</option>
            </select>
            <select id="lev-select" disabled>
                <option value="1">1x</option><option value="5">5x</option><option value="10" selected>10x</option>
                <option value="20">20x</option><option value="50">50x</option><option value="125">Max</option>
            </select>
        </div>
        <input type="number" id="margin-input" placeholder="ÏßÑÏûÖ Í∏àÏï° ($)" value="1000">
        
        <div class="dca-panel">
            <div><span class="dca-label">Ï∂îÎß§ GAP (%)</span><input type="number" id="dca-gap" value="-2.0" step="0.1"></div>
            <div><span class="dca-label">Ï∂îÎß§ Î∞∞Ïàò (x)</span><input type="number" id="dca-mult" value="1.0" step="0.1"></div>
            <div>
                <span class="dca-label">ÏûêÎèô Ï∂îÎß§</span>
                <button id="dca-btn" class="btn-auto" style="width:100%; padding:8px; font-size:10px;" onclick="toggleDCA()">OFF</button>
            </div>
        </div>

        <div class="ai-mode-panel">
            <select id="ai-mode-select" class="mode-select" onchange="updateAIModeColor()">
                <option value="STABLE">üõ°Ô∏è ÏïàÏ†ïÌòï (ÌòÑÎ¨ºÏúÑÏ£º)</option>
                <option value="MODERATE" selected>‚öñÔ∏è Î∞∏Îü∞Ïä§ (Ï§ëÍ∞Ñ)</option>
                <option value="AGGRESSIVE">‚öîÔ∏è Í≥µÍ≤©Ìòï (Í≥†Î†àÎ≤Ñ)</option>
            </select>
        </div>

        <div class="btn-row" style="margin-top:6px;">
            <button class="btn btn-long" onclick="manualEntry('LONG')">Îß§Ïàò / Î°±</button>
            <button id="short-btn" class="btn btn-short" onclick="manualEntry('SHORT')" disabled>Îß§ÎèÑ / Ïàè</button>
        </div>
        <div class="btn-row">
             <button id="auto-btn" class="btn btn-auto" onclick="toggleAuto()">ü§ñ AI START</button>
        </div>
        
        <button id="wake-lock-btn" class="wake-lock-btn" onclick="toggleWakeLock()">
            <span>‚ö° ÌôîÎ©¥ Í∫ºÏßê Î∞©ÏßÄ (No Sleep)</span>
        </button>
    </div>

    <div class="log-box" id="sys-log">> SYSTEM INITIALIZED.</div>

<script>
    let cash = 10000; 
    let portfolio = {}; 
    let prices = {}; 
    let isAuto = false;
    let isDCA = false;
    let wakeLock = null;
    
    // ÏΩîÏù∏ Ï¥àÍ∏∞ ÏãúÏÑ∏ ÏÉùÏÑ±
    const coins = ["BTC","ETH","SOL","BNB","XRP","ZRX","ONDO","SUI","ADA","AVAX","DOT","TRX","MATIC","LINK","ATOM","NEAR","APT","ARB","OP","STX","RNDR","FET","WLD","TAO","INJ","JASMY","GALA","SAND","UNI","AAVE","MKR","SNX","LTC","BCH","ETC","EOS","XLM","ALGO","DOGE","SHIB","PEPE","WIF","FLOKI","BONK","BOME","MEME"];
    coins.forEach(c => {
        let base = 100;
        if(c==='BTC') base=65000; if(c==='ETH') base=3500; if(c==='SOL') base=150; if(c==='XRP') base=0.6;
        prices[c] = base; 
    });

    const MAX_TOTAL_SLOTS = 20;  
    const MAX_MANUAL_SLOTS = 10; 

    // [ÌïµÏã¨ Fix] Ïï± ÏãúÏûë Ïãú Í∞ïÏ†úÎ°ú Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞ (Îç∞Î™® Î™®Îìú)
    function initDemoPositions() {
        if(Object.keys(portfolio).length === 0) {
            // Í∞ïÏ†ú ÏßÑÏûÖ 5Ï¢ÖÎ™©
            executeEntry("BTC", 1000, "SPOT", "LONG", 1, false, "(Auto Init)");
            executeEntry("ETH", 1000, "FUT", "LONG", 5, false, "(Auto Init)");
            executeEntry("SOL", 1000, "FUT", "LONG", 10, false, "(Auto Init)");
            executeEntry("XRP", 1000, "FUT", "SHORT", 5, false, "(Auto Init)");
            executeEntry("DOGE", 500, "FUT", "LONG", 20, false, "(Auto Init)");
            addLog("ÏãúÏä§ÌÖú", "Ï¥àÍ∏∞ Ïö¥Ïö© Ïä¨Î°Ø 5Í∞ú Î∞∞Ïπò ÏôÑÎ£å", "var(--gold)");
        }
    }

    // Í∞ÄÏÉÅ ÏÑúÎ≤Ñ ÏóîÏßÑ
    function virtualServerEngine() {
        // 1. ÏãúÏÑ∏ Î≥ÄÎèô
        coins.forEach(sym => {
            const volatility = 0.003; 
            const change = 1 + (Math.random() - 0.5) * volatility;
            prices[sym] = prices[sym] * change;
        });

        // 2. AI Î°úÏßÅ
        const activity = document.getElementById('ai-activity-text');
        
        if (isAuto) {
            const target = coins[Math.floor(Math.random() * coins.length)];
            const mockRSI = Math.floor(Math.random() * 100);
            activity.innerText = `AI Î∂ÑÏÑùÏ§ë: ${target} (RSI: ${mockRSI})`;

            if (mockRSI < 30) {
                if (!portfolio[target] && Object.keys(portfolio).length < 20) {
                    const mode = document.getElementById('ai-mode-select').value;
                    let lev = 1; let market = "SPOT";
                    if(mode === "AGGRESSIVE") { lev = 20; market = "FUT"; }
                    else if(mode === "MODERATE") { lev = 5; market = "FUT"; }
                    
                    if(Math.random() > 0.8) {
                        executeEntry(target, 1000, market, "LONG", lev, true, `(WebAI RSI:${mockRSI})`);
                    }
                }
            }
        } else {
            activity.innerText = isDCA ? "DCA Í∞êÏãúÏ§ë..." : "ÎåÄÍ∏∞Ï§ë...";
        }

        // 3. DCA
        if (isDCA) {
            const gap = parseFloat(document.getElementById('dca-gap').value);
            const mult = parseFloat(document.getElementById('dca-mult').value);
            for (let sym in portfolio) {
                const d = portfolio[sym];
                const p = prices[sym];
                
                // PnL Í≥ÑÏÇ∞ (Îã®ÏàúÌôî)
                let pnlPercent = 0;
                if(d.side === "LONG") pnlPercent = ((p - d.avg) / d.avg) * 100 * d.lev;
                else pnlPercent = ((d.avg - p) / d.avg) * 100 * d.lev;

                if (pnlPercent <= gap && Math.random() > 0.98) {
                    const addAmount = 1000 * mult;
                    if (cash >= addAmount) executeEntry(sym, addAmount, d.market, d.side, d.lev, true, `(DCA)`);
                }
            }
        }

        checkLiquidation();
        updateDashboard();
    }

    // ÌôîÎ©¥ Í∫ºÏßê Î∞©ÏßÄ
    async function toggleWakeLock() {
        const btn = document.getElementById('wake-lock-btn');
        if ('wakeLock' in navigator) {
            if (wakeLock === null) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    btn.classList.add('active');
                    btn.innerHTML = "<span>‚ö° ÌôîÎ©¥ Ïú†ÏßÄ Ï§ë (ÏºúÏßê)</span>";
                    addLog("ÏãúÏä§ÌÖú", "ÌôîÎ©¥ Í∫ºÏßê Î∞©ÏßÄ ÌôúÏÑ±Ìôî", "var(--gold)");
                } catch (err) { addLog("Ïò§Î•ò", "Wake Lock Ïã§Ìå®", "var(--down)"); }
            } else {
                wakeLock.release(); wakeLock = null;
                btn.classList.remove('active');
                btn.innerHTML = "<span>‚ö° ÌôîÎ©¥ Í∫ºÏßê Î∞©ÏßÄ (No Sleep)</span>";
                addLog("ÏãúÏä§ÌÖú", "ÌôîÎ©¥ Ïú†ÏßÄ Ìï¥Ï†ú", "#888");
            }
        } else { alert("Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§."); }
    }

    function selectActiveCoin(symbol, market) {
        document.getElementById('coin-select').value = symbol;
        document.getElementById('market-select').value = market;
        handleMarketChange();
        const cp = document.getElementById('control-panel');
        cp.style.borderColor = 'var(--gold)';
        setTimeout(() => { cp.style.borderColor = '#2b3139'; }, 300);
    }

    function handleMarketChange() {
        const market = document.getElementById('market-select').value;
        const lev = document.getElementById('lev-select');
        const sBtn = document.getElementById('short-btn');
        if (market === "SPOT") {
            lev.value = "1"; lev.disabled = true; sBtn.disabled = true; sBtn.style.opacity = "0.3";
        } else {
            lev.disabled = false; if(lev.value === "1") lev.value = "10"; sBtn.disabled = false; sBtn.style.opacity = "1";
        }
    }

    function updateAIModeColor() {
        const mode = document.getElementById('ai-mode-select').value;
        const btn = document.getElementById('auto-btn');
        btn.classList.remove('stable', 'moderate', 'aggressive');
        if (isAuto) {
            if (mode === 'STABLE') btn.classList.add('stable');
            else if (mode === 'MODERATE') btn.classList.add('moderate');
            else if (mode === 'AGGRESSIVE') btn.classList.add('aggressive');
        }
    }

    function toggleAuto() {
        isAuto = !isAuto;
        const btn = document.getElementById('auto-btn');
        const topBadge = document.getElementById('top-ai-badge');
        const topText = document.getElementById('top-ai-text');
        updateAIModeColor();
        if(isAuto) {
            btn.innerText = "AI RUNNING...";
            topBadge.className = "top-ai-badge on"; topText.innerText = "SYSTEM ON";
            addLog("ÏãúÏä§ÌÖú", "AI Í∞ÄÏÉÅ ÏóîÏßÑ Í∞ÄÎèô", "var(--up)");
            if(wakeLock === null) toggleWakeLock();
        } else {
            btn.innerText = "ü§ñ AI START";
            btn.classList.remove('stable', 'moderate', 'aggressive');
            topBadge.className = "top-ai-badge"; topText.innerText = "SYSTEM OFF";
            addLog("ÏãúÏä§ÌÖú", "AI ÏóîÏßÑ Ï†ïÏßÄ", "#888");
        }
    }

    function toggleDCA() {
        isDCA = !isDCA;
        const btn = document.getElementById('dca-btn');
        if(isDCA) { 
            btn.innerText = "ON (Í∞êÏãúÏ§ë)"; btn.classList.add('btn-dca-on'); 
            addLog("ÏãúÏä§ÌÖú", "Ïä§ÎßàÌä∏ DCA Í∞ÄÎèô", "var(--up)"); 
        } 
        else { 
            btn.innerText = "OFF"; btn.classList.remove('btn-dca-on'); 
            addLog("ÏãúÏä§ÌÖú", "Ïä§ÎßàÌä∏ DCA Ï†ïÏßÄ", "#888"); 
        }
    }

    function executeEntry(symbol, marginUSD, market, side, lev, isAutoTrade, reason="") {
        const price = prices[symbol];
        
        if (portfolio[symbol]) {
            const oldSize = portfolio[symbol].margin * portfolio[symbol].lev;
            const newSize = marginUSD * lev;
            const oldQty = oldSize / portfolio[symbol].avg;
            const newQty = newSize / price;
            portfolio[symbol].avg = (oldSize + newSize) / (oldQty + newQty);
            portfolio[symbol].margin += marginUSD;
            addLog(isAutoTrade ? "[AI] Ï∂îÎß§" : "[ÏàòÎèô] Ï∂îÎß§", `${symbol} ${reason} (+$${Math.floor(marginUSD)})`, "var(--gold)");
        } 
        else {
            const currentTotal = Object.keys(portfolio).length;
            if (isAutoTrade) { if (currentTotal >= MAX_TOTAL_SLOTS) return; } 
            else {
                if (!reason.includes("Init")) { // Ï¥àÍ∏∞ÌôîÍ∞Ä ÏïÑÎãêÎïåÎßå Ï≤¥ÌÅ¨
                    let manualCount = 0;
                    for(let k in portfolio) { if(!portfolio[k].isAuto) manualCount++; }
                    if (manualCount >= MAX_MANUAL_SLOTS) { alert(`‚õî ÏàòÎèô Ï†úÌïú(${MAX_MANUAL_SLOTS}Í∞ú) ÎèÑÎã¨!`); return; }
                    if (currentTotal >= MAX_TOTAL_SLOTS) { alert("‚õî Ï†ÑÏ≤¥ Ïä¨Î°Ø Í∞ÄÎìù Ï∞∏!"); return; }
                }
            }
            portfolio[symbol] = { avg: price, margin: marginUSD, market: market, side: side, lev: lev, isAuto: isAutoTrade };
            let badge = isAutoTrade ? "[AI]" : "[ÏàòÎèô]";
            if (reason.includes("Init")) badge = "[ÏãúÏä§ÌÖú]";
            let color = side==="LONG" ? "var(--up)" : "var(--down)";
            addLog(badge, `${symbol} ${side} x${lev} ÏßÑÏûÖ`, color);
        }
        cash -= marginUSD;
        updateDashboard();
    }

    function manualEntry(side) {
        const sym = document.getElementById('coin-select').value;
        const market = document.getElementById('market-select').value;
        const amt = parseFloat(document.getElementById('margin-input').value);
        let lev = parseInt(document.getElementById('lev-select').value);
        if(market === "SPOT") { side = "LONG"; lev = 1; }
        executeEntry(sym, amt, market, side, lev, false);
    }
    
    function getLiqPrice(d) {
        if (d.lev === 1) return 0;
        return d.side === "LONG" ? d.avg * (1 - (1/d.lev)) : d.avg * (1 + (1/d.lev));
    }
    
    function checkLiquidation() {
        for (let sym in portfolio) {
            const d = portfolio[sym];
            const p = prices[sym];
            const liq = getLiqPrice(d);
            if (d.lev > 1) { 
                if ((d.side === "LONG" && p <= liq) || (d.side === "SHORT" && p >= liq)) {
                    delete portfolio[sym];
                    addLog("Ï≤≠ÏÇ∞", `üí• ${sym} Í∞ïÏ†ú Ï≤≠ÏÇ∞`, "var(--down)");
                }
            }
        }
    }
    
    function updateDashboard() {
        const container = document.getElementById('slot-container');
        // Îπà Î©îÏãúÏßÄ Ï≤òÎ¶¨
        const keys = Object.keys(portfolio);
        if (keys.length === 0) {
            if(!document.getElementById('empty-msg')) container.innerHTML = '<div id="empty-msg" style="text-align:center;color:#444;padding:40px 0;font-size:12px;">NO POSITIONS</div>';
        } else {
            if(document.getElementById('empty-msg')) document.getElementById('empty-msg').remove();
        }

        let totalPnL = 0; let usedMargin = 0; let count = 0;
        
        for (let sym in portfolio) {
            count++;
            const d = portfolio[sym];
            const p = prices[sym] || d.avg;
            const liq = getLiqPrice(d);
            
            // PnL Í≥ÑÏÇ∞
            const positionSize = d.margin * d.lev;
            const coinSize = positionSize / d.avg;
            let pnl = d.side === "LONG" ? (p - d.avg) * coinSize : (d.avg - p) * coinSize;
            
            const roe = (pnl / d.margin) * 100;
            totalPnL += pnl; usedMargin += d.margin;
            const currentEquity = d.margin + pnl;

            // DOM ÏÉùÏÑ±
            let slot = document.getElementById(`slot-${sym}`);
            if (!slot) {
                slot = document.createElement('div');
                slot.id = `slot-${sym}`;
                slot.className = 'slot-item';
                slot.setAttribute('onclick', `selectActiveCoin('${sym}', '${d.market}')`);
                slot.innerHTML = `
                    <div class="coin-info">
                        <div class="coin-header">
                            <span class="coin-sym">${sym}</span>
                            <span class="lev-badge">${d.market} x${d.lev}</span>
                            <span class="side-badge ${d.side==='LONG'?'side-long':'side-short'}">${d.side}</span>
                            ${d.isAuto ? '<span class="auto-tag">AI</span>' : ''}
                            <span class="size-badge"></span>
                        </div>
                        <div class="detail-row">
                            <span>ÌèâÎã®: <span class="val-entry"></span></span>
                            <span>ÌòÑÏû¨: <span class="val-mark"></span></span>
                        </div>
                        <div class="detail-row liq-row"><span class="liq-val"></span> <span class="liq-dist"></span></div>
                        <div class="detail-row money-row">
                            <span class="money-label">Î≥∏Ï†Ñ: <span class="val-margin"></span></span>
                            <span class="money-val val-cur-money"></span>
                        </div>
                    </div>
                    <div class="slot-right">
                        <span class="pnl-text"></span>
                        <span class="pnl-val" style="font-size:11px;"></span>
                        <button class="close-btn" onclick="event.stopPropagation(); closePosition('${sym}')">Ï†ïÏÇ∞</button>
                    </div>`;
                container.appendChild(slot);
            }
            
            // Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
            let riskIcon = ""; if (d.lev >= 20) riskIcon = "üî•"; if (d.lev >= 50) riskIcon = "üíÄ";
            slot.querySelector('.size-badge').innerText = riskIcon + ' Size: $' + Math.floor(positionSize).toLocaleString();
            slot.querySelector('.val-entry').innerText = d.avg.toLocaleString(undefined, {maximumFractionDigits:4});
            slot.querySelector('.val-mark').innerText = p.toLocaleString(undefined, {maximumFractionDigits:4});
            slot.querySelector('.val-margin').innerText = '$' + Math.floor(d.margin).toLocaleString();
            
            const curMoneyEl = slot.querySelector('.val-cur-money');
            curMoneyEl.innerText = `ÏûîÏï°: $${Math.floor(currentEquity).toLocaleString()}`;
            curMoneyEl.style.color = pnl >= 0 ? "var(--up)" : "var(--down)";

            const liqValEl = slot.querySelector('.liq-val');
            const liqDistEl = slot.querySelector('.liq-dist');
            if (d.lev > 1) {
                const gapPercent = ((liq - p) / p) * 100;
                liqValEl.innerText = `Ï≤≠ÏÇ∞: ${liq < 1 ? liq.toFixed(5) : liq.toLocaleString()}`;
                liqDistEl.innerText = `Gap: (${Math.abs(gapPercent).toFixed(1)}%)`;
                if (Math.abs(gapPercent) < 3.0) liqDistEl.className = "liq-dist danger-dist";
                else liqDistEl.className = "liq-dist";
            } else { liqValEl.innerText = "Ï≤≠ÏÇ∞ ÏóÜÏùå (1x)"; liqDistEl.innerText = ""; }
            
            const pnlText = slot.querySelector('.pnl-text');
            pnlText.innerText = (roe >= 0 ? '+' : '') + roe.toFixed(2) + '%';
            pnlText.style.color = roe >= 0 ? "var(--up)" : "var(--down)";
            const pnlValEl = slot.querySelector('.pnl-val');
            pnlValEl.innerText = (pnl >= 0 ? '+' : '') + pnl.toFixed(2);
            pnlValEl.style.color = roe >= 0 ? "var(--up)" : "var(--down)";

            // ÌîåÎûòÏãú Ìö®Í≥º
            slot.classList.remove('flash-up', 'flash-down');
            void slot.offsetWidth; 
            if (p > d.avg) slot.classList.add('flash-up'); else if (p < d.avg) slot.classList.add('flash-down');
        }
        
        // ÏÇ≠Ï†úÎêú Ïä¨Î°Ø DOM Ï†úÍ±∞
        const existingSlots = container.querySelectorAll('.slot-item');
        existingSlots.forEach(el => { if (!portfolio[el.id.replace('slot-', '')]) el.remove(); });

        // [ÌïµÏã¨ Fix] ÏÉÅÎã® ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        document.getElementById('total-val').innerText = (cash + usedMargin + totalPnL).toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('active-count').innerText = count;
        document.getElementById('pnl-val').innerText = (totalPnL >= 0 ? '+' : '') + totalPnL.toFixed(2);
        document.getElementById('pnl-val').style.color = totalPnL >= 0 ? "var(--up)" : "var(--down)";
    }

    function closePosition(symbol) {
        if (!portfolio[symbol]) return;
        const d = portfolio[symbol];
        const p = prices[symbol] || d.avg;
        const coinSize = (d.margin * d.lev) / d.avg;
        let pnl = d.side === "LONG" ? (p - d.avg) * coinSize : (d.avg - p) * coinSize;
        cash += d.margin + pnl;
        delete portfolio[symbol];
        addLog("Ï†ïÏÇ∞", `${symbol} Ï¢ÖÎ£å`, pnl>=0?"var(--up)":"var(--down)");
        updateDashboard();
    }

    function addLog(action, msg, color) {
        const logBox = document.getElementById('sys-log');
        const time = new Date().toLocaleTimeString('ko-KR', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
        logBox.innerHTML = `<div><span style="color:#555">[${time}]</span> <span style="color:${color};font-weight:bold">${action}</span> ${msg}</div>` + logBox.innerHTML;
    }

    handleMarketChange();
    initDemoPositions(); // [ÏãúÏûë Ïãú Í∞ïÏ†ú Ïã§Ìñâ]
    setInterval(virtualServerEngine, 1000); 
</script>
</body>
</html>
